version: "3.9"

services:
  speaches:
    image: ghcr.io/speaches-ai/speaches:latest-cpu
    container_name: speaches
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - hf-hub-cache:/home/ubuntu/.cache/huggingface/hub

  # Service sekali jalan buat pre-download model
  speaches-init:
    image: curlimages/curl:8.11.1
    depends_on:
      - speaches
    environment:
      SPEACHES_BASE_URL: http://speaches:8000
    command: >
      sh -c "
        echo 'Waiting for speaches...';
        until curl -fsS ${SPEACHES_BASE_URL}/health >/dev/null 2>&1; do
          sleep 2;
        done;
        echo 'Downloading model guillaumekln/faster-whisper-base...';
        curl -fsS -X POST ${SPEACHES_BASE_URL}/v1/models/guillaumekln/faster-whisper-base;
        echo 'Model ready.';
      "

  app:
    build: .
    container_name: automate-tiktok-app
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      DOWNLOAD_JOB_INTERVAL_MS: 10000
      SPEACHES_BASE_URL: http://speaches:8000
      TRANSCRIPTION_MODEL_ID: guillaumekln/faster-whisper-base
    depends_on:
      - speaches-init
    volumes:
      - ./video:/app/video
      - ./audio:/app/audio
      - ./videos.db:/app/videos.db

volumes:
  hf-hub-cache:
