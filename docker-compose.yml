version: "3.9"

services:
  app:
    build: .
    image: automate-tiktok-app
    container_name: automate-tiktok-app
    restart: unless-stopped
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      PORT: ${PORT:-3000}
      DOWNLOAD_JOB_INTERVAL_MS: ${DOWNLOAD_JOB_INTERVAL_MS:-10000}
      TRANSCRIPTION_MODEL_ID: ${TRANSCRIPTION_MODEL_ID:-Systran/faster-whisper-small}
      TELEGRAM_NOTIFY_URL: ${TELEGRAM_NOTIFY_URL:-http://bot:3100}
      APP_BASE_URL: ${APP_BASE_URL:-http://app:3000}
    volumes:
      - ./video:/app/video
      - ./audio:/app/audio
      - ./videos.db:/app/videos.db

  bot:
    image: automate-tiktok-app   # pakai image yang sama dengan app
    container_name: automate-tiktok-bot
    restart: unless-stopped
    depends_on:
      - app
    command: npm run bot         # override CMD bawaan Dockerfile
    env_file:
      - .env
    environment:
      APP_BASE_URL: ${APP_BASE_URL:-http://app:3000}
      TELEGRAM_NOTIFY_URL: ${TELEGRAM_NOTIFY_URL:-http://bot:3100}
      TELEGRAM_BOT_PORT: ${TELEGRAM_BOT_PORT:-3100}
    ports:
      - "${TELEGRAM_BOT_PORT:-3100}:3100"
